<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <title>E‑redovalnica</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/fontkit@1.8.0/dist/fontkit.umd.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    nav { display: flex; background: #333; color: #fff; }
    nav button { flex: 1; padding: 15px; border: none; background: #333; color: #fff; font-weight: bold; cursor: pointer; }
    nav button.active { background: #555; }
    .page { display: none; padding: 20px; }
    .page.active { display: block; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #eee; }
    .student-name { font-weight: bold; }
    .student-surname { display: block; font-weight: normal; }
    .blue { color: #0066cc; font-weight: bold; }
    .red { color: #cc0000; font-weight: bold; }
    .black { color: #000; font-weight: bold; font-size: 1.2em; }
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 5; }
    .dialog { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,.3); z-index: 10; min-width: 260px; }
    .dialog h3 { margin-top: 0; }
    .dialog .bottom-bar { display: flex; justify-content: space-between; margin-top: 15px; }
    .dialog button { padding: 6px 12px; cursor: pointer; }
    .student-list { background: #fff; padding: 10px; }
    .student-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .student-item span { flex: 1; }
    input[type=text] { padding: 6px; margin-right: 8px; }
  </style>
</head>
<body>
<nav>
  <button class="tab-btn active" data-tab="redovalnica">Redovalnica</button>
  <button class="tab-btn" data-tab="nastavitve">Nastavitve</button>
</nav>
<div id="redovalnica" class="page active">
  <table id="gradeTable">
    <thead>
      <tr><th>UČENEC</th><th>SKLOP A</th><th>SKLOP B</th><th>SKLOP C</th><th>KONEC</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<div id="nastavitve" class="page">
  <h2>Seznam učencev</h2>
  <div id="studentList" class="student-list"></div>
  <h3>Dodaj novega učenca</h3>
  <input id="newName" type="text" placeholder="Ime" />
  <input id="newSurname" type="text" placeholder="Priimek" />
  <button id="addBtn">Dodaj</button>
</div>
<div id="overlay" class="overlay"></div>
<div id="dialog" class="dialog">
  <div id="dialogContent"></div>
  <div class="bottom-bar">
    <button id="cancelBtn">Prekliči</button>
    <button id="saveBtn">Shrani oceno</button>
  </div>
</div>

<script>
(async () => {
  const students = JSON.parse(localStorage.getItem('students') || '[]');
  const $$ = sel => document.querySelector(sel);
  const $$$ = sel => document.querySelectorAll(sel);
  const pdfUrl = 'OOC.pdf'; // Tvoj lokalni PDF v isti mapi
  const fontUrl = 'Roboto_SemiCondensed-Regular.ttf';

  function saveToStorage() {
    localStorage.setItem('students', JSON.stringify(students));
  }

  function renderTable() {
    const tbody = $$('#gradeTable tbody');
    tbody.innerHTML = '';
    students.forEach((s, i) => {
      const tr = document.createElement('tr');
      const tdName = document.createElement('td');
      tdName.innerHTML = `<span class="student-name">${s.name}</span><span class="student-surname">${s.surname}</span>`;
      tr.appendChild(tdName);
      ['a', 'b', 'c'].forEach(sk => {
        const td = document.createElement('td');
        td.innerHTML = (s[sk] || []).join(', ');
        td.onclick = () => openDialog(i, sk);
        tr.appendChild(td);
      });
      const tdFinal = document.createElement('td');
      tdFinal.innerHTML = s.final || '';
      tdFinal.onclick = () => openDialog(i, 'final');
      tr.appendChild(tdFinal);
      tbody.appendChild(tr);
    });
    renderStudentList();
  }

  function renderStudentList() {
    const list = $$('#studentList');
    list.innerHTML = '';
    students.forEach((s, i) => {
      const div = document.createElement('div');
      div.className = 'student-item';
      div.innerHTML = `<span>${s.name} ${s.surname}</span>` +
        `<button onclick="downloadOOC(${i})">OOC</button>` +
        `<button onclick="removeStudent(${i})">Izbriši</button>`;
      list.appendChild(div);
    });
  }

  $$('#addBtn').onclick = () => {
    const name = $$('#newName').value.trim();
    const surname = $$('#newSurname').value.trim();
    if (name && surname) {
      students.push({ name, surname, a: [], b: [], c: [], final: '' });
      $$('#newName').value = '';
      $$('#newSurname').value = '';
      saveToStorage();
      renderTable();
    }
  };

  window.removeStudent = index => {
    students.splice(index, 1);
    saveToStorage();
    renderTable();
  };

  const overlay = $$('#overlay');
  const dialog = $$('#dialog');
  const content = $$('#dialogContent');
  let activeStudent = -1, activeType = '';

  function openDialog(index, type) {
    activeStudent = index; activeType = type;
    overlay.style.display = 'block';
    dialog.style.display = 'block';

    if (type === 'final') {
      const s = students[index];
      const numGrades = [...s.a, ...s.b, ...s.c]
        .map(g => parseInt(g.replace(/<[^>]+>/g, '')))
        .filter(n => !isNaN(n));
      const avg = numGrades.length ? (numGrades.reduce((a, b) => a + b, 0) / numGrades.length).toFixed(2) : '–';

      content.innerHTML = `<h3>Končna ocena</h3><p>Povprečje: ${avg}</p>` +
        [1, 2, 3, 4, 5].map(n => `<div><input type="radio" name="gradeVal" id="g${n}" value="${n}"> <label for="g${n}">${n}</label></div>`).join('');
    } else {
      content.innerHTML = `<h3>Vpiši oceno</h3><label>Tip ocene:</label><select id="gradeType"><option value="blue">Ustna ocena</option><option value="red">Pisna ocena</option><option value="blue">Izdelek</option></select>` +
        [1, 2, 3, 4, 5].map(n => `<div><input type="radio" name="gradeVal" id="g${n}" value="${n}"> <label for="g${n}">${n}</label></div>`).join('');
    }
  }

  function closeDialog() {
    overlay.style.display = 'none';
    dialog.style.display = 'none';
    content.innerHTML = '';
    activeStudent = -1;
    activeType = '';
  }
  $$('#cancelBtn').onclick = closeDialog;

  $$('#saveBtn').onclick = () => {
    const sel = document.querySelector('input[name="gradeVal"]:checked');
    if (!sel) { alert('Izberi oceno!'); return; }
    const val = sel.value;
    if (activeType === 'final') {
      students[activeStudent].final = `<span class="black">${val}</span>`;
    } else {
      const colour = $$('#gradeType').value;
      const formatted = `<span class="${colour}">${val}</span>`;
      students[activeStudent][activeType].push(formatted);
    }
    saveToStorage();
    closeDialog();
    renderTable();
  };

  overlay.onclick = closeDialog;

  // PDF generation
  window.downloadOOC = async i => {
    try {
      const existingPdfBytes = await fetch(pdfUrl).then(res => res.arrayBuffer());
      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);

      // register fontkit
      pdfDoc.registerFontkit(fontkit);

      // load custom font
      const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
      const robotoFont = await pdfDoc.embedFont(fontBytes);

      const page = pdfDoc.getPage(0);
      const s = students[i];
      const grades = {
        a: s.a.map(g => g.replace(/<[^>]+>/g, '')),
        b: s.b.map(g => g.replace(/<[^>]+>/g, '')),
        c: s.c.map(g => g.replace(/<[^>]+>/g, ''))
      };
      const finalRaw = s.final.replace(/<[^>]+>/g, '') || '';
      const all = [...grades.a, ...grades.b, ...grades.c];
      const negatives = all.filter(g => g === '1').length;

      // Logika uspeha po polju "konec" (finalRaw)
      // Če je prazno -> "še ni določen"
      // Če ni enega od 1-5 in N -> "ne ocenjen"
      // Drug primer: 1-5 in pripadajoči opis
      // Za sme/ne sme je max 3 negativne ocene

      let uspehText = '';
      switch (finalRaw) {
        case '':
          uspehText = 'še ni določen';
          break;
        case 'N':
          uspehText = 'ne ocenjen';
          break;
        case '1':
          uspehText = 'nezadosten (1)';
          break;
        case '2':
          uspehText = 'zadosten (2)';
          break;
        case '3':
          uspehText = 'dober (3)';
          break;
        case '4':
          uspehText = 'prav dober (4)';
          break;
        case '5':
          uspehText = 'odličen (5)';
          break;
        default:
          uspehText = 'ne ocenjen';
      }

      const smeText = negatives <= 3 ? 'sme' : 'ne sme';
      const ref = 'REF-' + Date.now();

      // Pomembno: v PDF-lib so enote v točkah (pt)
      // 1 mm = 2.835 pt približno

      function mmToPt(mm) { return mm * 2.835; }

      // Koordinate (X, Y) v mm iz tvojih podatkov
      // Besedilo bo na sredini po X, razen za ime zgoraj, ki je bolj levo.

      // Ime in priimek (levo malce bolj levo)
      page.drawText(`${s.name} ${s.surname}`, {
        x: mmToPt(105.3) - 40, // premaknemo malo levo od sredine
        y: page.getHeight() - mmToPt(53.2),
        size: 12,
        font: robotoFont,
      });

      // Funkcija za risanje sredinsko poravnanega teksta na podanem X (centerX) in Y
      function drawCenteredText(text, centerXmm, ymm) {
        const size = 12;
        const textWidth = robotoFont.widthOfTextAtSize(text, size);
        const centerXpt = mmToPt(centerXmm);
        const x = centerXpt - textWidth / 2;
        const y = page.getHeight() - mmToPt(ymm);
        page.drawText(text, { x, y, size, font: robotoFont });
      }

      drawCenteredText(grades.a.join(', '), 110.7, 102.7);
      drawCenteredText(grades.b.join(', '), 113.9, 124.9);
      drawCenteredText(grades.c.join(', '), 105.6, 145);
      drawCenteredText(finalRaw || '-', 109.1, 165.6);
      drawCenteredText(String(negatives), 169.5, 189.2);
      drawCenteredText(`${s.name} ${s.surname}`, 137.3, 202.8);
      drawCenteredText(smeText, 44.4, 216.2);
      drawCenteredText(uspehText, 128.9, 238.3);
      page.drawText(ref, {
        x: mmToPt(38.1),
        y: page.getHeight() - mmToPt(263.6),
        size: 10,
        font: robotoFont,
      });

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `OOC_${s.name}_${s.surname}.pdf`;
      link.click();
    } catch (e) {
      alert('Napaka pri generiranju PDF‑ja: ' + e.message);
      console.error(e);
    }
  };

  $$$('.tab-btn').forEach(btn => btn.onclick = () => {
    $$$('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    $$$('.page').forEach(p => p.classList.remove('active'));
    $(`#${btn.dataset.tab}`).classList.add('active');
  });

  renderTable();
})();
</script>
</body>
</html>
