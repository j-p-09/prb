<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <title>E-redovalnica - PDF generiranje</title>
  <!-- Naloži fontkit -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fontkit/2.0.2/fontkit.min.js"></script>
  <!-- Naloži pdf-lib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
    // fontkit mora biti globalno dostopen
    window.fontkit = fontkit;
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #eee;
    }
    button {
      cursor: pointer;
      padding: 6px 12px;
      margin: 4px;
    }
    .student-name {
      font-weight: bold;
      display: block;
    }
    .student-surname {
      display: block;
      font-weight: normal;
      font-style: italic;
    }
  </style>
</head>
<body>

<h1>E-redovalnica</h1>
<table id="gradeTable">
  <thead>
    <tr>
      <th>Učenec</th>
      <th>Skupina A</th>
      <th>Skupina B</th>
      <th>Skupina C</th>
      <th>Končna</th>
      <th>PDF</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
(async () => {
  // Font datoteka: lahko uporabiš svoj font ali ta URL
  // Za demo: naložimo Google font Roboto Regular iz URL-ja
  // Tukaj uporabim eno izmed javno dostopnih font datotek (TTF)
  const fontUrl = 'https://github.com/google/fonts/raw/main/apache/roboto/static/Roboto-Regular.ttf';
  const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());

  // Podatki o učencih s primer ocenami (stringi, lahko so več ocen)
  let students = [
    {name: "Ana", surname: "Kovač", a: ["1", "3"], b: ["2"], c: ["5"], final: "3"},
    {name: "Bine", surname: "Novak", a: ["2", "1"], b: ["1", "1", "1"], c: ["3"], final: "2"},
    {name: "Cilka", surname: "Zupan", a: ["4"], b: ["5"], c: ["5"], final: "5"},
    {name: "David", surname: "Hribar", a: ["1", "1", "1", "1"], b: ["2"], c: ["3"], final: "1"},
  ];

  const tbody = document.querySelector("#gradeTable tbody");

  // Pomagaj funkciji za preverjanje negativnih ocen (ocena "1")
  function countNegatives(gradesArr) {
    return gradesArr.filter(g => g === "1").length;
  }

  // Za vsakega učenca izriši vrstico v tabeli
  function renderTable() {
    tbody.innerHTML = "";
    students.forEach((s, i) => {
      const tr = document.createElement("tr");

      // Ime in priimek
      const tdName = document.createElement("td");
      tdName.innerHTML = `<span class="student-name">${s.name}</span><span class="student-surname">${s.surname}</span>`;
      tr.appendChild(tdName);

      // Skupina A, B, C - združene ocene z vejicami
      ["a", "b", "c"].forEach(sk => {
        const td = document.createElement("td");
        td.textContent = s[sk].join(", ");
        tr.appendChild(td);
      });

      // Končna ocena
      const tdFinal = document.createElement("td");
      tdFinal.textContent = s.final;
      tr.appendChild(tdFinal);

      // Gumb za generiranje PDF
      const tdBtn = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent = "Generiraj PDF";
      btn.onclick = () => generatePdf(i);
      tdBtn.appendChild(btn);
      tr.appendChild(tdBtn);

      tbody.appendChild(tr);
    });
  }

  // Funkcija za generiranje PDF za učenca z index i
  async function generatePdf(i) {
    try {
      const s = students[i];
      const existingPdfBytes = await fetch("https://pdf-lib.js.org/assets/with_update_sections.pdf").then(res => res.arrayBuffer());
      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
      pdfDoc.registerFontkit(fontkit);
      const customFont = await pdfDoc.embedFont(fontBytes);

      const page = pdfDoc.getPage(0);

      // Združi vse ocene za štetje negativnih
      const allGrades = [...s.a, ...s.b, ...s.c];
      const negativeCount = countNegatives(allGrades);

      // Pravilo za sme/ne sme glede na 3 ali manj negativnih
      const smeNeSme = negativeCount <= 3 ? "sme" : "ne sme";

      // Funkcija za risanje teksta centrirano na x koordinati (v mm)
      function mmToPt(mm) {
        return mm * 2.83465; // 1 mm = 2.83465 pt
      }

      // Počistimo vse že narišano (ni nujno, ampak za varnost)
      // -- tukaj preskočimo, ker uporabljamo predlogo PDFja

      // Izpišemo podatke na PDF stran
      const fontSize = 12;
      page.drawText(`${s.name} ${s.surname}`, {
        x: mmToPt(30),
        y: mmToPt(250),
        size: fontSize,
        font: customFont,
        color: PDFLib.rgb(0, 0, 0)
      });

      page.drawText(`Skupina A: ${s.a.join(", ")}`, {
        x: mmToPt(30),
        y: mmToPt(240),
        size: fontSize,
        font: customFont
      });
      page.drawText(`Skupina B: ${s.b.join(", ")}`, {
        x: mmToPt(30),
        y: mmToPt(230),
        size: fontSize,
        font: customFont
      });
      page.drawText(`Skupina C: ${s.c.join(", ")}`, {
        x: mmToPt(30),
        y: mmToPt(220),
        size: fontSize,
        font: customFont
      });
      page.drawText(`Končna ocena: ${s.final}`, {
        x: mmToPt(30),
        y: mmToPt(210),
        size: fontSize,
        font: customFont
      });

      page.drawText(`Število negativnih ocen: ${negativeCount}`, {
        x: mmToPt(30),
        y: mmToPt(200),
        size: fontSize,
        font: customFont
      });

      page.drawText(`Odločitev: ${smeNeSme}`, {
        x: mmToPt(30),
        y: mmToPt(190),
        size: fontSize + 2,
        font: customFont,
        color: PDFLib.rgb(1, 0, 0) // rdeča barva
      });

      // Shrani PDF in sproži prenos
      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `OOC_${s.name}_${s.surname}.pdf`;
      a.click();
      URL.revokeObjectURL(url);

    } catch (e) {
      alert("Napaka pri generiranju PDF: " + e.message);
    }
  }

  renderTable();

})();
</script>

</body>
</html>
