<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <title>E‑redovalnica</title>

  <!-- pdf-lib in fontkit -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f4f4}
    nav{display:flex;background:#333}
    nav button{flex:1;padding:15px;border:none;background:#333;color:#fff;font-weight:bold;cursor:pointer}
    nav button.active{background:#555}
    .page{display:none;padding:20px}
    .page.active{display:block}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #ccc;padding:10px;text-align:center}
    th{background:#eee}
    .student-name{font-weight:bold}
    .student-surname{display:block;font-weight:normal}
    .blue{color:#0066cc;font-weight:bold}
    .red{color:#cc0000;font-weight:bold}
    .black{color:#000;font-weight:bold;font-size:1.2em}
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:5}
    .dialog{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 0 10px rgba(0,0,0,.3);z-index:10;min-width:260px}
    .dialog h3{margin-top:0}
    .dialog .bottom-bar{display:flex;justify-content:space-between;margin-top:15px}
    .dialog button{padding:6px 12px;cursor:pointer}
    .student-list{background:#fff;padding:10px}
    .student-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .student-item span{flex:1}
    input[type=text]{padding:6px;margin-right:8px}
  </style>
</head>
<body>
<nav>
  <button class="tab-btn active" data-tab="redovalnica">Redovalnica</button>
  <button class="tab-btn" data-tab="nastavitve">Nastavitve</button>
</nav>

<!-- stran redovalnice -->
<div id="redovalnica" class="page active">
  <table id="gradeTable">
    <thead>
      <tr><th>UČENEC</th><th>SKLOP A</th><th>SKLOP B</th><th>SKLOP C</th><th>KONEC</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- stran nastavitev -->
<div id="nastavitve" class="page">
  <h2>Seznam učencev</h2>
  <div id="studentList" class="student-list"></div>
  <h3>Dodaj novega učenca</h3>
  <input id="newName"  type="text" placeholder="Ime">
  <input id="newSurname" type="text" placeholder="Priimek">
  <button id="addBtn">Dodaj</button>
</div>

<!-- dialog za vnos ocen -->
<div id="overlay" class="overlay"></div>
<div id="dialog" class="dialog">
  <div id="dialogContent"></div>
  <div class="bottom-bar">
    <button id="cancelBtn">Prekliči</button>
    <button id="saveBtn">Shrani oceno</button>
  </div>
</div>

<script>
(async ()=>{

  /* ---------- PERSISTENCA ---------- */
  const STORAGE_KEY = 'eredovalnicaStudents';
  const students = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

  function saveStudents() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(students));
  }

  /* ---------- POMOČNE FUNKCIJE ---------- */
  const $$ = sel => document.querySelector(sel);
  const $$$ = sel => document.querySelectorAll(sel);
  const mm  = v => v * 2.83465;          // mm -> pt
  const yPt = mmVal => 842 - mm(mmVal);  // invertirana y‑os (A4 višina 842 pt)

  /* ---------- TABELA REDOVALNICE ---------- */
  function renderTable() {
    const tbody = $$('#gradeTable tbody');
    tbody.innerHTML = '';
    students.forEach((s,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td><span class="student-name">${s.name}</span><span class="student-surname">${s.surname}</span></td>` +
        ['a','b','c'].map(sk=>`<td data-i="${i}" data-sk="${sk}">${(s[sk]||[]).join(', ')}</td>`).join('') +
        `<td data-i="${i}" data-sk="final">${s.final||''}</td>`;
      tbody.appendChild(tr);
    });

    // klik na celico -> dialog
    $$$('#gradeTable tbody td').forEach(td=>{
      td.onclick = ()=>openDialog(+td.dataset.i, td.dataset.sk);
    });
  }

  /* ---------- SEZNAM UČENCEV V NASTAVITVAH ---------- */
  function renderStudentList() {
    const list = $$('#studentList');
    list.innerHTML = '';
    students.forEach((s,i)=>{
      const row = document.createElement('div');
      row.className='student-item';
      row.innerHTML =
        `<span>${s.name} ${s.surname}</span>` +
        `<button onclick="downloadOOC(${i})">OOC</button>` +
        `<button onclick="removeStudent(${i})">Izbriši</button>`;
      list.appendChild(row);
    });
  }

  /* ---------- DODAJANJE / BRISANJE UČENCA ---------- */
  $$('#addBtn').onclick = ()=>{
    const name = $$('#newName').value.trim();
    const surname = $$('#newSurname').value.trim();
    if(name && surname){
      students.push({ name, surname, a:[], b:[], c:[], final:'' });
      $$('#newName').value = '';
      $$('#newSurname').value = '';
      saveStudents();
      renderTable(); renderStudentList();
    }
  };
  window.removeStudent = i=>{
    students.splice(i,1);
    saveStudents();
    renderTable(); renderStudentList();
  };

  /* ---------- DIALOG ZA OCENE ---------- */
  const overlay=$$('#overlay');
  const dialog=$$('#dialog');
  const content=$$('#dialogContent');
  let activeStudent=-1, activeType='';

  function openDialog(i,type){
    activeStudent=i; activeType=type;
    overlay.style.display='block';
    dialog.style.display='block';

    if(type==='final'){
      const s = students[i];
      const num = [...s.a,...s.b,...s.c].map(g=>parseInt(g.replace(/<[^>]+>/g,''))).filter(x=>!isNaN(x));
      const avg = num.length ? (num.reduce((a,b)=>a+b,0)/num.length).toFixed(2) : '–';
      content.innerHTML = `<h3>Končna ocena</h3><p>Povprečje: ${avg}</p>` +
        [1,2,3,4,5].map(n=>`<div><input type="radio" name="grade" id="g${n}" value="${n}"><label for="g${n}">${n}</label></div>`).join('');
    } else {
      content.innerHTML = `<h3>Vpiši oceno</h3><label>Tip ocene:</label>`+
        `<select id="gradeType"><option value="blue">Ustna</option><option value="red">Pisna</option><option value="blue">Izdelek</option></select>` +
        [1,2,3,4,5].map(n=>`<div><input type="radio" name="grade" id="g${n}" value="${n}"><label for="g${n}">${n}</label></div>`).join('');
    }
  }
  function closeDialog(){overlay.style.display='none';dialog.style.display='none';content.innerHTML='';}
  $$('#cancelBtn').onclick = closeDialog;
  $$('#saveBtn').onclick = ()=>{
    const sel = document.querySelector('input[name="grade"]:checked');
    if(!sel){alert('Izberi oceno');return;}
    const val = sel.value;
    const s = students[activeStudent];

    if(activeType==='final'){
      s.final = `<span class="black">${val}</span>`;
    } else {
      const clr = $$('#gradeType').value;
      s[activeType].push(`<span class="${clr}">${val}</span>`);
    }
    saveStudents();
    closeDialog();
    renderTable();
  };
  overlay.onclick = closeDialog;

  /* ---------- GENERACIJA PDF ---------- */
  window.downloadOOC = async i=>{
    try{
      const pdfBytes = await fetch('OOC.pdf').then(r=>r.arrayBuffer());
      const ttfBytes = await fetch('Roboto_SemiCondensed-Regular.ttf').then(r=>r.arrayBuffer());

      const doc = await PDFLib.PDFDocument.load(pdfBytes);
      doc.registerFontkit(fontkit);
      const font = await doc.embedFont(ttfBytes);
      const page = doc.getPage(0);

      const s = students[i];
      const grades = { a: s.a.map(g=>g.replace(/<[^>]+>/g,'')),
                       b: s.b.map(g=>g.replace(/<[^>]+>/g,'')),
                       c: s.c.map(g=>g.replace(/<[^>]+>/g,'')) };
      const final = s.final.replace(/<[^>]+>/g,'');
      const all   = [...grades.a,...grades.b,...grades.c];
      const negatives = all.filter(g=>'1'===g).length;
      const decision  = negatives===0 ? 'sme' : 'ne sme';
      const ref = 'REF-'+Date.now();

      page.drawText(`${s.name} ${s.surname}`, { x:mm(105.3), y:yPt(53.2), size:12, font });
      page.drawText(grades.a.join(', '),      { x:mm(110.7), y:yPt(102.7),size:12, font });
      page.drawText(grades.b.join(', '),      { x:mm(113.9), y:yPt(124.9),size:12, font });
      page.drawText(grades.c.join(', '),      { x:mm(105.6), y:yPt(145.0),size:12, font });
      page.drawText(final||'-',               { x:mm(109.1), y:yPt(165.6),size:12, font });
      page.drawText(String(negatives),        { x:mm(169.5), y:yPt(189.2),size:12, font });
      page.drawText(`${s.name} ${s.surname}`, { x:mm(137.3), y:yPt(202.8),size:12, font });
      page.drawText(decision,                 { x:mm(44.4 ), y:yPt(216.2),size:12, font });
      page.drawText('še ni določen',          { x:mm(128.9), y:yPt(238.3),size:12, font });
      page.drawText(ref,                      { x:mm(38.1 ), y:yPt(263.6),size:10, font });

      const outBytes = await doc.save();
      const blob = new Blob([outBytes],{type:'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `OOC_${s.name}_${s.surname}.pdf`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }catch(e){
      alert('Napaka pri generiranju PDF‑ja: '+e.message);
      console.error(e);
    }
  };

  /* ---------- PREKLOP TABOV ---------- */
  $$$('.tab-btn').forEach(btn=>btn.onclick=()=>{
    $$$('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    $$$('.page').forEach(p=>p.classList.remove('active'));
    $$('#'+btn.dataset.tab).classList.add('active');
  });

  /* ---------- ZAŽENI PRVI RENDER ---------- */
  renderTable(); renderStudentList();
})();
</script>
</body>
</html>
