<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8" />
<title>E‑redovalnica</title>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fontkit/2.0.2/fontkit.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }
  nav { display:flex; background:#333; color:#fff; }
  nav button { flex:1; padding:15px; border:none; background:#333; color:#fff; font-weight:bold; cursor:pointer; }
  nav button.active { background:#555; }
  .page { display:none; padding:20px; }
  .page.active { display:block; }
  table { width:100%; border-collapse: collapse; background:#fff; }
  th, td { border:1px solid #ccc; padding:10px; text-align:center; vertical-align: middle; }
  th { background:#eee; }
  .student-name { font-weight:bold; display:inline-block; text-align:left; min-width:80px; }
  .student-surname { display:block; font-weight:normal; }
  .blue { color:#0066cc; font-weight:bold; }
  .red { color:#cc0000; font-weight:bold; }
  .black { color:#000; font-weight:bold; font-size:1.2em; }
  .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:5; }
  .dialog { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
           background:#fff; padding:20px; border:1px solid #ccc; box-shadow:0 0 10px rgba(0,0,0,.3);
           z-index:10; min-width:260px; }
  .dialog h3 { margin-top:0; }
  .dialog .bottom-bar { display:flex; justify-content:space-between; margin-top:15px; }
  .dialog button { padding:6px 12px; cursor:pointer; }
  .student-list { background:#fff; padding:10px; }
  .student-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .student-item span { flex:1; }
  input[type=text] { padding:6px; margin-right:8px; }
</style>
</head>
<body>

<nav>
  <button class="tab-btn active" data-tab="redovalnica">Redovalnica</button>
  <button class="tab-btn" data-tab="nastavitve">Nastavitve</button>
</nav>

<div id="redovalnica" class="page active">
  <table id="gradeTable">
    <thead>
      <tr>
        <th>UČENEC</th><th>SKLOP A</th><th>SKLOP B</th><th>SKLOP C</th><th>KONEC</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="nastavitve" class="page">
  <h2>Seznam učencev</h2>
  <div id="studentList" class="student-list"></div>
  <h3>Dodaj novega učenca</h3>
  <input id="newName" type="text" placeholder="Ime" />
  <input id="newSurname" type="text" placeholder="Priimek" />
  <button id="addBtn">Dodaj</button>
</div>

<div id="overlay" class="overlay"></div>
<div id="dialog" class="dialog">
  <div id="dialogContent"></div>
  <div class="bottom-bar">
    <button id="cancelBtn">Prekliči</button>
    <button id="saveBtn">Shrani oceno</button>
  </div>
</div>

<script>
(async () => {
  const $$ = (sel) => document.querySelector(sel);
  const $$$ = (sel) => document.querySelectorAll(sel);
  const pdfUrl = 'OOC.pdf';
  const fontUrl = 'Roboto_SemiCondensed-Regular.ttf';

  // Naloži font in PDF
  const [fontBytes, existingPdfBytes] = await Promise.all([
    fetch(fontUrl).then((r) => r.arrayBuffer()),
    fetch(pdfUrl).then((r) => r.arrayBuffer())
  ]);

  // Shranjevanje in branje učencev iz LocalStorage
  let students = JSON.parse(localStorage.getItem('students') || '[]');

  function saveStudents() {
    localStorage.setItem('students', JSON.stringify(students));
  }

  // Render tabele in seznama
  function renderTable() {
    const tbody = $$('#gradeTable tbody');
    tbody.innerHTML = '';
    students.forEach((s, i) => {
      const tr = document.createElement('tr');
      // Ime in priimek - ime malo bolj levo (text-align left)
      const tdName = document.createElement('td');
      tdName.style.textAlign = 'left';
      tdName.innerHTML = `<span class="student-name">${s.name}</span> <span class="student-surname">${s.surname}</span>`;
      tr.appendChild(tdName);

      ['a', 'b', 'c'].forEach((sk) => {
        const td = document.createElement('td');
        td.style.textAlign = 'center'; // ocene na sredino
        td.innerHTML = (s[sk] || []).join(', ');
        td.onclick = () => openDialog(i, sk);
        tr.appendChild(td);
      });

      const tdFinal = document.createElement('td');
      tdFinal.style.textAlign = 'center';
      tdFinal.innerHTML = s.final || '';
      tdFinal.onclick = () => openDialog(i, 'final');
      tr.appendChild(tdFinal);
      tbody.appendChild(tr);
    });
    renderStudentList();
    saveStudents();
  }

  function renderStudentList() {
    const list = $$('#studentList');
    list.innerHTML = '';
    students.forEach((s, i) => {
      const div = document.createElement('div');
      div.className = 'student-item';
      div.innerHTML = `<span>${s.name} ${s.surname}</span>` +
        `<button onclick="downloadOOC(${i})">OOC</button>` +
        `<button onclick="removeStudent(${i})">Izbriši</button>`;
      list.appendChild(div);
    });
  }

  // Dodaj novega učenca
  $$('#addBtn').onclick = () => {
    const name = $$('#newName').value.trim();
    const surname = $$('#newSurname').value.trim();
    if (name && surname) {
      students.push({ name, surname, a: [], b: [], c: [], final: '' });
      $$('#newName').value = '';
      $$('#newSurname').value = '';
      renderTable();
    }
  };

  window.removeStudent = (index) => {
    students.splice(index, 1);
    renderTable();
  };

  const overlay = $$('#overlay');
  const dialog = $$('#dialog');
  const content = $$('#dialogContent');
  let activeStudent = -1, activeType = '';

  function openDialog(index, type) {
    activeStudent = index; activeType = type;
    overlay.style.display = 'block';
    dialog.style.display = 'block';

    if (type === 'final') {
      const s = students[index];
      // Izračun povprečja vseh ocen (a, b, c)
      const allGrades = [...s.a, ...s.b, ...s.c]
        .map(g => parseInt(g.replace(/<[^>]+>/g, '')))
        .filter(n => !isNaN(n));
      const avg = allGrades.length ? (allGrades.reduce((a, b) => a + b, 0) / allGrades.length).toFixed(2) : '–';

      content.innerHTML = `<h3>Končna ocena</h3>
      <p>Povprečje: ${avg}</p>
      <div><input type="radio" name="gradeVal" id="gN" value="N"><label for="gN">N - ne ocenjen</label></div>
      <div><input type="radio" name="gradeVal" id="gPrazno" value=""><label for="gPrazno">Prazno - še ni določen</label></div>
      <div><input type="radio" name="gradeVal" id="g1" value="1"><label for="g1">1 - nezadosten (1)</label></div>
      <div><input type="radio" name="gradeVal" id="g2" value="2"><label for="g2">2 - zadosten (2)</label></div>
      <div><input type="radio" name="gradeVal" id="g3" value="3"><label for="g3">3 - dober (3)</label></div>
      <div><input type="radio" name="gradeVal" id="g4" value="4"><label for="g4">4 - prav dober (4)</label></div>
      <div><input type="radio" name="gradeVal" id="g5" value="5"><label for="g5">5 - odličen (5)</label></div>`;
      // prednastavi trenutno vrednost
      const radios = content.querySelectorAll('input[name="gradeVal"]');
      radios.forEach(radio => {
        if (radio.value === s.final.replace(/<[^>]+>/g, '')) {
          radio.checked = true;
        }
      });
    } else {
      content.innerHTML = `<h3>Vpiši oceno</h3>
      <label>Tip ocene:</label>
      <select id="gradeType">
        <option value="blue">Ustna ocena</option>
        <option value="red">Pisna ocena</option>
        <option value="blue">Izdelek</option>
      </select>` +
        [1, 2, 3, 4, 5].map(n => `<div><input type="radio" name="gradeVal" id="g${n}" value="${n}"> <label for="g${n}">${n}</label></div>`).join('');
    }
  }

  function closeDialog() {
    overlay.style.display = 'none';
    dialog.style.display = 'none';
    content.innerHTML = '';
    activeStudent = -1;
    activeType = '';
  }

  $$('#cancelBtn').onclick = closeDialog;

  $$('#saveBtn').onclick = () => {
    const sel = document.querySelector('input[name="gradeVal"]:checked');
    if (!sel) {
      alert('Izberi oceno!');
      return;
    }
    const val = sel.value;
    if (activeType === 'final') {
      students[activeStudent].final = val === '' ? '' : `<span class="black">${val}</span>`;
    } else {
      const colour = $$('#gradeType').value;
      students[activeStudent][activeType].push(`<span class="${colour}">${val}</span>`);
    }
    closeDialog();
    renderTable();
  };

  overlay.onclick = closeDialog;

  // Zavihek menija
  $$$('.tab-btn').forEach(btn => {
    btn.onclick = () => {
      $$$('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      $$$('.page').forEach(p => p.classList.remove('active'));
      $$('#' + btn.dataset.tab).classList.add('active');
    };
  });

  // Funkcija za prenos PDF (generiranje in izpolnjevanje)
  window.downloadOOC = async (i) => {
    try {
      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
      pdfDoc.registerFontkit(fontkit);
      const customFont = await pdfDoc.embedFont(fontBytes);

      const page = pdfDoc.getPage(0);
      const s = students[i];

      // Ocene brez HTML oznak
      const grades = {
        a: s.a.map(g => g.replace(/<[^>]+>/g, '')),
        b: s.b.map(g => g.replace(/<[^>]+>/g, '')),
        c: s.c.map(g => g.replace(/<[^>]+>/g, ''))
      };
      const finalRaw = s.final.replace(/<[^>]+>/g, '');

      // Štetje nezadostnih ocen za odločitev
      const all = [...grades.a, ...grades.b, ...grades.c];
      const negatives = all.filter(g => g === '1').length;
      const decision = negatives === 0 ? 'sme' : 'ne sme';

      // Referenčna številka (lahko spremeniš)
      const ref = 'REF-' + (1000 + i);

      // Čiščenje predhodnih vsebin
      page.drawRectangle({ x: 50, y: 700, width: 500, height: 100, color: PDFLib.rgb(1, 1, 1), blendMode: 'multiply' });

      // Ime in priimek - levo
      page.drawText(`${s.name} ${s.surname}`, {
        x: 50,
        y: 730,
        size: 14,
        font: customFont,
        color: PDFLib.rgb(0, 0, 0)
      });

      // Ocene - na sredino posameznih področij (primer pozicije)
      const positions = {
        a: 200,
        b: 280,
        c: 360,
        final: 450
      };

      ['a', 'b', 'c'].forEach((sk) => {
        const text = grades[sk].join(', ');
        const fontSize = 12;
        const textWidth = customFont.widthOfTextAtSize(text, fontSize);
        const xCenter = positions[sk];
        const pageWidth = page.getWidth();
        page.drawText(text, {
          x: xCenter - textWidth / 2,
          y: 720,
          size: fontSize,
          font: customFont,
          color: PDFLib.rgb(0, 0, 1)
        });
      });

      // Končna ocena na sredino
      if (finalRaw) {
        const fontSize = 14;
        const textWidth = customFont.widthOfTextAtSize(finalRaw, fontSize);
        page.drawText(finalRaw, {
          x: positions.final - textWidth / 2,
          y: 700,
          size: fontSize,
          font: customFont,
          color: PDFLib.rgb(0, 0, 0)
        });
      }

      // Izpis uspeha (rdeče / črno)
      page.drawText(`Učenec ${decision} opraviti zaključni izpit.`, {
        x: 50,
        y: 650,
        size: 12,
        font: customFont,
        color: negatives === 0 ? PDFLib.rgb(0, 0, 0) : PDFLib.rgb(1, 0, 0)
      });

      // Shrani in prenesi
      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${s.name}_${s.surname}_OOC.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (e) {
      alert('Napaka pri generiranju PDF: ' + e.message);
      console.error(e);
    }
  };

  renderTable();

})();
</script>

</body>
</html>
